{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user profile within the SecureLearn application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile."
        },
        "googleId": {
          "type": "string",
          "description": "The user's Google ID from Google Sign-In."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "department": {
          "type": "string",
          "description": "User's department within Apfelkiste."
        },
        "name": {
          "type": "string",
          "description": "User's full name."
        }
      },
      "required": [
        "id",
        "googleId",
        "email",
        "department",
        "name"
      ]
    },
    "Module": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Module",
      "type": "object",
      "description": "Represents a security training module.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the module."
        },
        "title": {
          "type": "string",
          "description": "Title of the module."
        },
        "description": {
          "type": "string",
          "description": "Description of the module."
        },
        "order": {
          "type": "number",
          "description": "The order the module should appear in."
        }
      },
      "required": [
        "id",
        "title",
        "description"
      ]
    },
    "UserModuleProgress": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserModuleProgress",
      "type": "object",
      "description": "Represents a user's progress on a specific training module.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user module progress entry."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N UserModuleProgress)"
        },
        "moduleId": {
          "type": "string",
          "description": "Reference to Module. (Relationship: Module 1:N UserModuleProgress)"
        },
        "completionStatus": {
          "type": "string",
          "description": "Status of the module completion (e.g., 'not started', 'in progress', 'completed')."
        },
        "lastAccessTime": {
          "type": "string",
          "description": "Timestamp of the user's last access to the module.",
          "format": "date-time"
        },
        "retakeRequired": {
          "type": "boolean",
          "description": "Indicates if the module needs to be retaken."
        }
      },
      "required": [
        "id",
        "userId",
        "moduleId",
        "completionStatus"
      ]
    },
    "QuizQuestion": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QuizQuestion",
      "type": "object",
      "description": "Represents a quiz question.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the quiz question."
        },
        "moduleId": {
          "type": "string",
          "description": "Reference to Module. (Relationship: Module 1:N QuizQuestion)"
        },
        "questionText": {
          "type": "string",
          "description": "The text of the quiz question."
        },
        "options": {
          "type": "array",
          "description": "An array of possible answer options for the question.",
          "items": {
            "type": "string"
          }
        },
        "correctAnswerIndex": {
          "type": "number",
          "description": "The index of the correct answer in the options array."
        },
        "explanation": {
          "type": "string",
          "description": "Explanation for the correct answer, displayed as feedback."
        }
      },
      "required": [
        "id",
        "questionText",
        "options",
        "correctAnswerIndex",
        "explanation"
      ]
    },
    "UserQuizResult": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserQuizResult",
      "type": "object",
      "description": "Represents a user's result for a quiz.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user quiz result."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N UserQuizResult)"
        },
        "moduleId": {
          "type": "string",
          "description": "Reference to Module. (Relationship: Module 1:N UserQuizResult)"
        },
        "score": {
          "type": "number",
          "description": "The user's score on the quiz."
        },
        "completionTime": {
          "type": "string",
          "description": "Timestamp of when the user completed the quiz.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "moduleId",
        "score",
        "completionTime"
      ]
    },
    "Certificate": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Certificate",
      "type": "object",
      "description": "Represents a certificate awarded to a user upon completion of all modules.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the certificate."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:1 Certificate)"
        },
        "issueDate": {
          "type": "string",
          "description": "Date when the certificate was issued.",
          "format": "date-time"
        },
        "expiryDate": {
          "type": "string",
          "description": "Date when the certificate expires.",
          "format": "date-time"
        },
        "isValid": {
          "type": "boolean",
          "description": "Indicates if the certificate is currently valid."
        },
        "certificateURL": {
          "type": "string",
          "description": "URL where the certificate can be accessed.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "userId",
        "issueDate",
        "expiryDate",
        "isValid"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. Accessible only by the user themselves.  Includes 'userId' as document ID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/modules/{moduleId}",
        "definition": {
          "entityName": "Module",
          "schema": {
            "$ref": "#/backend/entities/Module"
          },
          "description": "Stores security training modules. Accessible to all users, but only modifiable by admins. Includes 'moduleId' as document ID.",
          "params": [
            {
              "name": "moduleId",
              "description": "The unique identifier for the module."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/moduleProgress/{moduleProgressId}",
        "definition": {
          "entityName": "UserModuleProgress",
          "schema": {
            "$ref": "#/backend/entities/UserModuleProgress"
          },
          "description": "Stores a user's progress on a specific training module. Accessible only by the user themselves. Includes denormalized 'userId' and 'moduleId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "moduleProgressId",
              "description": "The unique identifier for the user module progress entry."
            }
          ]
        }
      },
      {
        "path": "/modules/{moduleId}/quizQuestions/{questionId}",
        "definition": {
          "entityName": "QuizQuestion",
          "schema": {
            "$ref": "#/backend/entities/QuizQuestion"
          },
          "description": "Stores quiz questions for a specific module.  Accessible only by admins. Includes denormalized 'moduleId' for authorization independence.",
          "params": [
            {
              "name": "moduleId",
              "description": "The unique identifier for the module."
            },
            {
              "name": "questionId",
              "description": "The unique identifier for the quiz question."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/quizResults/{quizResultId}",
        "definition": {
          "entityName": "UserQuizResult",
          "schema": {
            "$ref": "#/backend/entities/UserQuizResult"
          },
          "description": "Stores a user's quiz result. Accessible only by the user themselves. Includes denormalized 'userId' and 'moduleId'.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "quizResultId",
              "description": "The unique identifier for the user quiz result."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/certificates/{certificateId}",
        "definition": {
          "entityName": "Certificate",
          "schema": {
            "$ref": "#/backend/entities/Certificate"
          },
          "description": "Stores a user's certificate. Accessible only by the user themselves.  Includes 'userId' as document ID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "certificateId",
              "description": "The unique identifier for the certificate."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure is designed for the Apfelkiste SecureLearn application, prioritizing security, scalability, and ease of debugging. It follows the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), QAPs (Rules are not Filters), and Invariants.  The structure uses denormalization to achieve authorization independence and structural segregation to simplify security rules and enable secure list operations. It leverages path-based ownership for user-specific data and membership maps where collaboration is needed.\n\n**Authorization Independence:** The structure avoids hierarchical authorization dependencies (no `get()` calls in security rules) by denormalizing authorization-related data. For instance, any module access control attributes needed within `UserModuleProgress` are copied into those documents.\n\n**Structural Segregation:**  Data with different access requirements is stored in separate collections. User profiles are segregated under `/users/{userId}`, while modules are stored in a top-level `/modules` collection.\n\n**QAPs (Rules are not Filters):** The structure supports secure list operations. For example, listing modules is straightforward because the `/modules` collection contains only module data, and security rules can efficiently control access.\n\n**Access Modeling:**\n*   **User Profiles:** `/users/{userId}` ensures only the user can access their profile data.\n*   **Modules:** `/modules` allows for centralized management of module data.\n*   **User Module Progress:** `/users/{userId}/moduleProgress/{moduleProgressId}` establishes a clear ownership model and relationship between users and their module progress. The  `userId` is denormalized into the `UserModuleProgress` document, guaranteeing Authorization Independence. ModuleId is also denormalized. \n*   **Quiz Questions:** `/modules/{moduleId}/quizQuestions/{questionId}` enforces admin management of questions for each module. Denormalizing the `moduleId` into each question document enables Authorization Independence.\n*   **User Quiz Results:** `/users/{userId}/quizResults/{quizResultId}` reflects user-specific quiz results.\n*   **Certificates:** `/users/{userId}/certificates/{certificateId}` stores user-specific certificates.\n\n**Production Environment:** The structure is well-suited for a production environment, providing a secure and scalable foundation for the SecureLearn application. The design uses explicit naming and conventions to ensure consistency and maintainability."
  }
}