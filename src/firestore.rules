/**
 * @file Firestore Security Rules for SecureLearn Application (Prototyping Mode)
 * @version 3
 *
 * @description This ruleset enforces a strict user-ownership model for personal data while allowing public read access to module information.
 * It also defines an admin role that can read across user data for administrative purposes.
 *
 * @dataStructure
 * - /users/{userId}: Stores user profile data, accessible only by the user themselves. Admins can read this data.
 * - /modules/{moduleId}: Stores module information, publicly readable but writeable only by admins (not implemented in this prototype).
 * - /settings/company-guidelines: Stores the company guidelines text, readable by any authenticated user, writeable by admins.
 * - /users/{userId}/moduleProgress/{moduleProgressId}: Stores user progress on modules, accessible only by the user themselves. Admins have list access via collection group query.
 * - /modules/{moduleId}/quizQuestions/{questionId}: Stores quiz questions, accessible only by admins (not implemented in this prototype).
 * - /users/{userId}/quizResults/{quizResultId}: Stores user quiz results, accessible only by the user themselves.
 * - /users/{userId}/certificates/{certificateId}: Stores user certificates, accessible only by the user themselves.
 *
 * @keySecurityDecisions
 * - User data is strictly isolated and accessible only by the owning user for write operations.
 * - Admin role is introduced, allowing read access to all user profiles and list access to all module progress.
 * - Collection group queries are secured to only be accessible by admins.
 *
 * @denormalizationForAuthorization
 * - The `UserModuleProgress` documents denormalize `userId` and `moduleId` to enable authorization checks without requiring additional `get()` calls.
 * - User profile documents contain a 'role' field used for admin authorization.
 *
 * @structuralSegregation
 * - User-specific data is stored under the `/users/{userId}` path, ensuring clear ownership and isolation.
 * - Publicly accessible module data is stored in the top-level `/modules` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function isAdmin() {
      // Admins can read any user's profile data.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // Only admins can list users.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    match /settings/{docId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    match /modules/{moduleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Rule for the collection group query used by admins.
    match /{path=**}/moduleProgress/{progressId} {
      allow list: if isAdmin();
    }

    match /users/{userId}/moduleProgress/{moduleProgressId} {
      allow get: if isOwner(userId);
      // 'list' is handled by the collection group rule for admins, 
      // but we still need a rule for users querying their own progress.
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    match /modules/{moduleId}/quizQuestions/{questionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /users/{userId}/quizResults/{quizResultId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/certificates/{certificateId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}
